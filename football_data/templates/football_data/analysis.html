{% extends 'base.html' %}
{% load static %}

{% block title %}Análisis de Partidos - Predicciones Completas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/football_data/analysis.css' %}">
<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-text {
        font-size: 18px;
        color: #333;
        font-weight: bold;
    }
    
    .loading-text-progress {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }
    
    .prediction-badge {
        font-size: 13px;
        padding: 5px 10px;
        font-weight: 600;
    }
    
    .table-responsive {
        max-height: 800px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: flex;">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Cargando predicciones...</div>
        <div class="loading-text-progress" id="loading-progress">Iniciando análisis...</div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="text-primary"><i class="fas fa-chart-line"></i> Análisis Completo de Predicciones</h1>
                    <p class="text-muted mb-0">Análisis multi-modelo para los próximos 24 horas</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-success">
                        <i class="fas fa-sync-alt"></i> Actualizado: <span id="updated-time">{{ updated_at|date:"H:i" }}</span>
                    </span>
                    <p class="text-muted small mb-0 mt-2">Total partidos: <strong id="total-matches">0</strong> / <span id="total-available">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de Colores -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <div>
                    <strong>Leyenda de Colores (Ambos Marcan):</strong>
                    <span class="badge bg-success ms-2">Verde: ≥60% (Alta probabilidad)</span>
                    <span class="badge bg-warning ms-2">Amarillo: 40-59% (Probabilidad media)</span>
                    <span class="badge bg-danger ms-2">Rojo: <40% (Baja probabilidad)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Partidos -->
    {% if matches %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-futbol"></i> Partidos de las Próximas 24 Horas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th>Liga</th>
                                    <th>Local</th>
                                    <th>Visitante</th>
                                    <th>Fecha</th>
                                    <th>Hora (CO)</th>
                                    <th class="text-center">Remates Total</th>
                                    <th class="text-center">Remates Local</th>
                                    <th class="text-center">Remates Visit.</th>
                                    <th class="text-center">Remates a Puerta</th>
                                    <th class="text-center">Goles Total</th>
                                    <th class="text-center">Goles Local</th>
                                    <th class="text-center">Goles Visit.</th>
                                    <th class="text-center">Corners Total</th>
                                    <th class="text-center">Corners Local</th>
                                    <th class="text-center">Corners Visit.</th>
                                    <th class="text-center">Ambos Marcan</th>
                                </tr>
                            </thead>
                            <tbody id="matches-tbody">
                                <!-- Las filas se cargarán dinámicamente vía AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>No hay partidos disponibles</h5>
                <p class="mb-0">No se encontraron partidos programados para las próximas 24 horas.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información Adicional -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <i class="fas fa-cogs fa-2x text-primary mb-2"></i>
                    <h6>Modelo Utilizado</h6>
                    <p class="small text-muted mb-0">Predicción Oficial (Ensemble Multi-Modelo)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <i class="fas fa-sync-alt fa-2x text-success mb-2"></i>
                    <h6>Actualización Automática</h6>
                    <p class="small text-muted mb-0">Los datos se actualizan al cargar la página</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h6>Zona Horaria</h6>
                    <p class="small text-muted mb-0">Hora en Colombia (UTC-5)</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingProgress = document.getElementById('loading-progress');
    const matchesTbody = document.getElementById('matches-tbody');
    const totalMatchesEl = document.getElementById('total-matches');
    const totalAvailableEl = document.getElementById('total-available');
    const updatedTimeEl = document.getElementById('updated-time');
    
    let currentOffset = 0;
    let totalAvailable = 0;
    let allProcessedMatches = [];
    
    // Función para agregar una fila a la tabla
    function addMatchRow(match) {
        const row = document.createElement('tr');
        
        // Función helper para formatear predicción
        function formatPrediction(pred) {
            if (!pred || pred === null || pred === undefined) return '<span class="text-muted">-</span>';
            const value = typeof pred === 'object' && pred.prediction !== undefined ? pred.prediction : pred;
            return `<span class="badge bg-info prediction-badge">${parseFloat(value).toFixed(1)}</span>`;
        }
        
        // Función helper para badges de goles
        function formatGoalPrediction(pred) {
            if (!pred || pred === null || pred === undefined) return '<span class="text-muted">-</span>';
            const value = typeof pred === 'object' && pred.prediction !== undefined ? pred.prediction : pred;
            return `<span class="badge bg-success prediction-badge">${parseFloat(value).toFixed(1)}</span>`;
        }
        
        // Función helper para badges de corners
        function formatCornerPrediction(pred) {
            if (!pred || pred === null || pred === undefined) return '<span class="text-muted">-</span>';
            const value = typeof pred === 'object' && pred.prediction !== undefined ? pred.prediction : pred;
            return `<span class="badge bg-warning prediction-badge">${parseFloat(value).toFixed(1)}</span>`;
        }
        
        // Función helper para ambos marcan
        function formatBothTeamsScore(pct) {
            if (pct === null || pct === undefined) return '<span class="text-muted">-</span>';
            const value = parseFloat(pct);
            let badgeClass = 'bg-danger';
            if (value >= 60) badgeClass = 'bg-success';
            else if (value >= 40) badgeClass = 'bg-warning';
            return `<span class="badge ${badgeClass} fs-6">${value.toFixed(1)}%</span>`;
        }
        
        const predictions = match.predictions || {};
        
        row.innerHTML = `
            <td><span class="badge bg-secondary">${match.league || '-'}</span></td>
            <td><strong>${match.home_team || '-'}</strong></td>
            <td><strong>${match.away_team || '-'}</strong></td>
            <td>${match.date || '-'}</td>
            <td><i class="fas fa-clock text-primary"></i> ${match.time || '-'}</td>
            <td class="text-center">${formatPrediction(predictions.shots_total)}</td>
            <td class="text-center">${formatPrediction(predictions.shots_home)}</td>
            <td class="text-center">${formatPrediction(predictions.shots_away)}</td>
            <td class="text-center">${formatPrediction(predictions.shots_on_target_total)}</td>
            <td class="text-center">${formatGoalPrediction(predictions.goals_total)}</td>
            <td class="text-center">${formatGoalPrediction(predictions.goals_home)}</td>
            <td class="text-center">${formatGoalPrediction(predictions.goals_away)}</td>
            <td class="text-center">${formatCornerPrediction(predictions.corners_total)}</td>
            <td class="text-center">${formatCornerPrediction(predictions.corners_home)}</td>
            <td class="text-center">${formatCornerPrediction(predictions.corners_away)}</td>
            <td class="text-center">${formatBothTeamsScore(match.prediction)}</td>
        `;
        
        matchesTbody.appendChild(row);
    }
    
    // Función para cargar el siguiente lote
    function loadNextBatch() {
        const progressText = totalAvailable > 0 
            ? `Procesando partidos... (${Math.min(currentOffset + 1, totalAvailable)}-${Math.min(currentOffset + 3, totalAvailable)} de ${totalAvailable})`
            : `Procesando partidos...`;
        loadingProgress.textContent = progressText;
        
        fetch(`{% url 'football_data:analysis_ajax' %}?offset=${currentOffset}&batch_size=3`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar total disponible si es la primera vez
                    if (totalAvailable === 0 && data.total > 0) {
                        totalAvailable = data.total;
                        totalAvailableEl.textContent = data.total;
                    }
                    
                    // Agregar partidos procesados
                    if (data.matches && data.matches.length > 0) {
                        data.matches.forEach(match => {
                            allProcessedMatches.push(match);
                            addMatchRow(match);
                        });
                        
                        // Ordenar por fecha y hora
                        allProcessedMatches.sort((a, b) => {
                            const dateA = a.date + ' ' + a.time;
                            const dateB = b.date + ' ' + b.time;
                            return dateA.localeCompare(dateB);
                        });
                        
                        // Re-renderizar tabla ordenada
                        matchesTbody.innerHTML = '';
                        allProcessedMatches.forEach(match => addMatchRow(match));
                    }
                    
                    // Actualizar contadores
                    totalMatchesEl.textContent = allProcessedMatches.length;
                    currentOffset = data.offset + data.processed_count;
                    
                    // Continuar si hay más partidos
                    if (data.has_more && data.total > 0) {
                        setTimeout(loadNextBatch, 500); // Esperar 500ms antes del siguiente lote
                    } else {
                        // Terminó la carga
                        if (allProcessedMatches.length === 0) {
                            loadingProgress.textContent = '⚠️ No se encontraron partidos disponibles';
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                                // Mostrar mensaje en la tabla
                                matchesTbody.innerHTML = `
                                    <tr>
                                        <td colspan="16" class="text-center py-5">
                                            <div class="alert alert-warning mb-0">
                                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                                <h5>No hay partidos disponibles</h5>
                                                <p class="mb-0">No se encontraron partidos programados para las próximas 24 horas.</p>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }, 1500);
                        } else {
                            loadingProgress.textContent = `✅ Completado: ${allProcessedMatches.length} partidos procesados`;
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                                updatedTimeEl.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            }, 1000);
                        }
                    }
                } else {
                    // Error
                    loadingProgress.textContent = '❌ Error al cargar partidos';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loadingProgress.textContent = '❌ Error de conexión';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 2000);
            });
    }
    
    // Iniciar carga
    loadingOverlay.style.display = 'flex';
    loadNextBatch();
});
</script>
{% endblock %}
